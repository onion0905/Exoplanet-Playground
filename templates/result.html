<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA Hackathon - Prediction Results</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="importmap">
    {
        "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/examples/jsm/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: white;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .back-btn {
            position: absolute;
            top: 2rem;
            left: 2rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 25px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .page-title {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            font-size: 1.1rem;
            color: #b8b8b8;
            margin-bottom: 2rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .results-table-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            overflow: hidden;
        }

        .results-table th,
        .results-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .results-table th {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
            font-weight: 600;
        }

        .results-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .prediction-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .exoplanet {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.4);
        }

        .false-positive {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
            border: 1px solid rgba(244, 67, 54, 0.4);
        }

        .explain-btn {
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .explain-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }

        .widgets-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .widget {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            max-height: 450px;
            overflow-y: auto;
        }

        .confidence-widget {
            text-align: center;
        }

        .confidence-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 1rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: conic-gradient(from 0deg, #4CAF50 0deg, #4CAF50 var(--percentage), rgba(255, 255, 255, 0.1) var(--percentage), rgba(255, 255, 255, 0.1) 360deg);
        }

        .confidence-circle::before {
            content: '';
            position: absolute;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: #1a1a2e;
        }

        .confidence-text {
            position: relative;
            z-index: 1;
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .explanation-widget {
            display: none;
        }

        .explanation-loading {
            text-align: center;
            padding: 2rem;
            color: #b8b8b8;
        }

        .explanation-chart {
            height: 250px;
            max-height: 250px;
            margin-top: 1rem;
            width: 100%;
        }

        .visualization-widget {
            display: none;
            height: 350px;
            max-height: 350px;
            position: relative;
            overflow: hidden;
            border-radius: 10px;
        }

        .visualization-canvas {
            width: 100%;
            height: 100%;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4ecdc4;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .model-summary {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.9rem;
            color: #b8b8b8;
            margin-bottom: 0.25rem;
        }

        .summary-value {
            font-size: 1.2rem;
            color: #ffffff;
            font-weight: 600;
        }

        .instance-details {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1rem;
            display: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            max-height: 400px;
            overflow-y: auto;
        }

        .selected-instance {
            background: rgba(78, 205, 196, 0.1) !important;
            border-left: 4px solid #4ecdc4;
        }

        .detail-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detail-label {
            color: #b8b8b8;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            color: #ffffff;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .feature-values-grid {
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .feature-value-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.8rem;
            border-radius: 6px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .feature-name {
            color: #4ecdc4;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.3rem;
        }

        .feature-value {
            color: #ffffff;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .feature-importance {
            color: #b8b8b8;
            font-size: 0.8rem;
        }

        .analysis-summary {
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        @media (max-width: 1024px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .widgets-container {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .widget {
                flex: 1;
                min-width: 250px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .results-table-container {
                padding: 1rem;
                overflow-x: auto;
            }
            
            .results-table {
                min-width: 600px;
            }
            
            .page-title {
                font-size: 2rem;
            }
        }

        /* Visualization button styles from original Visualization.html */
        .viz-button {
            padding: 5px 18px;
            margin: 12px;
            font-size: 18px;
            font-family: "Segoe UI", Roboto, sans-serif;
            font-weight: 600;
            color: #ffffff;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 14px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(0, 180, 255, 0.5), inset 0 0 10px rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease-in-out;
        }

        .viz-button::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0,200,255,0.4) 0%, transparent 70%);
            transform: rotate(25deg);
            opacity: 0.4;
            transition: all 0.5s ease-in-out;
        }

        .viz-button:hover {
            color: #00eaff;
            border-color: rgba(0, 234, 255, 0.8);
            box-shadow: 0 0 25px rgba(0, 234, 255, 0.9), inset 0 0 15px rgba(0, 234, 255, 0.3);
            background: linear-gradient(135deg, #1a2a6c, #2b5876, #4e4376);
        }

        .viz-button:hover::before {
            opacity: 0.8;
            transform: rotate(45deg) scale(1.2);
        }

        .viz-button:active {
            transform: scale(0.96);
            box-shadow: 0 0 15px rgba(0, 180, 255, 0.6), inset 0 0 12px rgba(0, 180, 255, 0.4);
        }
    </style>
</head>
<body>
    <a href="/predict" class="back-btn">‚Üê Back to Prediction</a>
    
    <div class="container">
        <div class="header">
            <h1 class="page-title">üéØ Prediction Results</h1>
            <p class="page-subtitle">Analyze your model's predictions with detailed explanations and visualizations</p>
        </div>

        <!-- Model Summary -->
        <div class="model-summary">
            <div class="summary-item">
                <div class="summary-label">Model Type</div>
                <div class="summary-value" id="modelType">{{ model_info.type }}</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Dataset Used</div>
                <div class="summary-value" id="datasetUsed">{{ model_info.dataset }}</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Total Predictions</div>
                <div class="summary-value" id="totalPredictions">{{ prediction_data|length }}</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Exoplanets Found</div>
                <div class="summary-value" id="exoplanetsFound">{{ exoplanets_count }}</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">False Positives</div>
                <div class="summary-value" id="falsePositives">{{ false_positives_count }}</div>
            </div>
        </div>

        <div class="results-grid">
            <!-- Results Table -->
            <div class="results-table-container">
                <h2 class="section-title">
                    üìä Prediction Results
                </h2>
                
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Instance ID</th>
                            <th>Period (days)</th>
                            <th>Transit Duration</th>
                            <th>Depth (ppm)</th>
                            <th>Prediction</th>
                            <th>Confidence</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in prediction_data %}
                        <tr class="result-row" data-instance-id="{{ item.id }}">
                            <td>{{ item.id }}</td>
                            <td>{{ item.period }}</td>
                            <td>{{ item.duration }}</td>
                            <td>{{ item.depth }}</td>
                            <td>
                                <span class="prediction-badge {{ 'exoplanet' if item.prediction == 'Exoplanet' else 'false-positive' }}">
                                    {{ item.prediction }}
                                </span>
                            </td>
                            <td>{{ item.confidence }}%</td>
                            <td>
                                <button class="explain-btn" onclick="explainInstance({{ item.id }})">
                                    Explain & Visualize
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Widgets -->
            <div class="widgets-container">
                <!-- Overall Confidence Widget -->
                <div class="widget confidence-widget">
                    <h3 class="section-title">üéØ Overall Confidence</h3>
                    <div class="confidence-circle" style="--percentage: {{ overall_confidence * 3.6 }}deg">
                        <div class="confidence-text">{{ overall_confidence }}%</div>
                    </div>
                    <p style="color: #b8b8b8; font-size: 0.9rem;">Average prediction confidence across all instances</p>
                </div>

                <!-- Explanation Widget -->
                <div class="widget explanation-widget" id="explanationWidget">
                    <h3 class="section-title">üß† Feature Explanation</h3>
                    <div id="explanationContent">
                        <div class="explanation-loading">
                            Select an instance to see feature importance analysis
                        </div>
                    </div>
                    <canvas id="explanationChart" class="explanation-chart" style="display: none;"></canvas>
                </div>

                <!-- Visualization Widget -->
                <div class="widget visualization-widget" id="visualizationWidget">
                    <h3 class="section-title">üåå 3D Visualization</h3>
                    <div class="visualization-controls" style="margin-bottom: 1rem; text-align: center;">
                        <button class="viz-button" id="btnHaumea">Haumea</button>
                        <button class="viz-button" id="btnEarth">Earth</button>
                    </div>
                    <canvas class="visualization-canvas" id="visualizationCanvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Instance Details Panel -->
        <div class="instance-details" id="instanceDetails">
            <h3 style="margin-bottom: 1rem;">Instance Details</h3>
            <div id="instanceDetailsContent"></div>
        </div>
    </div>

    <script>
        let selectedInstanceId = null;
        let explanationChart = null;
        let scene = null;
        let renderer = null;
        let camera = null;

        // Sample explanation data for different instances
        const explanationData = {
            1: {
                features: ['Period', 'Duration', 'Depth', 'Signal Noise', 'Stellar Magnitude', 'Temperature'],
                importance: [0.35, 0.28, 0.22, 0.08, 0.05, 0.02],
                values: [3.52, 6.2, 1200, 15.2, 12.3, 5780]
            },
            2: {
                features: ['Period', 'Duration', 'Depth', 'Signal Noise', 'Stellar Magnitude', 'Temperature'],
                importance: [0.42, 0.31, 0.18, 0.05, 0.03, 0.01],
                values: [89.5, 13.1, 890, 8.7, 11.8, 6200]
            },
            3: {
                features: ['Period', 'Duration', 'Depth', 'Signal Noise', 'Stellar Magnitude', 'Temperature'],
                importance: [0.38, 0.25, 0.24, 0.07, 0.04, 0.02],
                values: [15.7, 4.8, 2100, 12.3, 13.1, 5430]
            },
            4: {
                features: ['Period', 'Duration', 'Depth', 'Signal Noise', 'Stellar Magnitude', 'Temperature'],
                importance: [0.29, 0.33, 0.26, 0.06, 0.04, 0.02],
                values: [7.2, 8.9, 750, 9.8, 10.9, 5890]
            },
            5: {
                features: ['Period', 'Duration', 'Depth', 'Signal Noise', 'Stellar Magnitude', 'Temperature'],
                importance: [0.45, 0.27, 0.19, 0.05, 0.03, 0.01],
                values: [124.3, 11.6, 1450, 7.2, 12.7, 6100]
            }
        };

        function explainInstance(instanceId) {
            selectedInstanceId = instanceId;
            
            // Highlight selected row with animation
            document.querySelectorAll('.result-row').forEach(row => {
                row.classList.remove('selected-instance');
            });
            const selectedRow = document.querySelector(`[data-instance-id="${instanceId}"]`);
            selectedRow.classList.add('selected-instance');
            
            // Smooth scroll to selected row
            selectedRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Show widgets with fade-in animation
            const explanationWidget = document.getElementById('explanationWidget');
            const visualizationWidget = document.getElementById('visualizationWidget');
            const instanceDetails = document.getElementById('instanceDetails');
            
            // Reset any previous transformations and ensure proper display
            [explanationWidget, visualizationWidget, instanceDetails].forEach(widget => {
                if (widget) {
                    widget.style.display = 'block';
                    widget.style.opacity = '0';
                    widget.style.transform = 'translateY(10px)';
                    widget.style.transition = 'all 0.3s ease-out';
                    widget.style.maxHeight = widget.classList.contains('visualization-widget') ? '350px' : '450px';
                    widget.style.overflow = 'hidden';
                }
            });
            
            // Add fade-in animation with shorter duration
            setTimeout(() => {
                [explanationWidget, visualizationWidget, instanceDetails].forEach(widget => {
                    if (widget) {
                        widget.style.opacity = '1';
                        widget.style.transform = 'translateY(0)';
                    }
                });
            }, 50);
            
            // Show loading state with enhanced animation
            document.getElementById('explanationContent').innerHTML = `
                <div class="explanation-loading">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 0.5rem;">Analyzing feature importance for Instance ${instanceId}...</p>
                    <div style="background: rgba(78, 205, 196, 0.1); border-radius: 8px; padding: 0.5rem; margin-top: 1rem; font-size: 0.8rem;">
                        üîç Running explainable AI analysis...
                    </div>
                </div>
            `;
            
            // Update confidence circle for selected instance
            updateConfidenceCircle(instanceId);
            
            // Simulate loading delay with progress updates
            const loadingSteps = [
                "Extracting feature vectors...",
                "Computing SHAP values...",
                "Analyzing feature interactions...",
                "Generating explanations..."
            ];
            
            let stepIndex = 0;
            const stepInterval = setInterval(() => {
                if (stepIndex < loadingSteps.length) {
                    document.querySelector('.explanation-loading p').textContent = loadingSteps[stepIndex];
                    stepIndex++;
                } else {
                    clearInterval(stepInterval);
                    setTimeout(() => {
                        showExplanation(instanceId);
                        initializeVisualization();
                        showInstanceDetails(instanceId);
                        updateVisualizationData();
                    }, 500);
                }
            }, 500);
        }

        function updateConfidenceCircle(instanceId) {
            const instanceRow = document.querySelector(`[data-instance-id="${instanceId}"]`);
            const confidence = parseFloat(instanceRow.cells[5].textContent);
            const prediction = instanceRow.querySelector('.prediction-badge').textContent.trim();
            
            // Update confidence circle
            const confidenceCircle = document.querySelector('.confidence-circle');
            const confidenceText = document.querySelector('.confidence-text');
            
            if (confidenceCircle && confidenceText) {
                // Animate the circle
                confidenceCircle.style.setProperty('--percentage', `${confidence * 3.6}deg`);
                
                // Update text with animation
                confidenceText.style.transform = 'scale(0.8)';
                confidenceText.style.transition = 'transform 0.3s ease';
                
                setTimeout(() => {
                    confidenceText.textContent = `${confidence}%`;
                    confidenceText.style.transform = 'scale(1)';
                    
                    // Update color based on prediction
                    const color = prediction === 'Exoplanet' ? '#4CAF50' : '#F44336';
                    confidenceText.style.color = color;
                    
                    // Update circle gradient
                    const gradient = `conic-gradient(from 0deg, ${color} 0deg, ${color} ${confidence * 3.6}deg, rgba(255, 255, 255, 0.1) ${confidence * 3.6}deg, rgba(255, 255, 255, 0.1) 360deg)`;
                    confidenceCircle.style.background = gradient;
                }, 300);
            }
        }

        function showExplanation(instanceId) {
            const data = explanationData[instanceId] || explanationData[1];
            
            document.getElementById('explanationContent').innerHTML = `
                <p style="color: #b8b8b8; font-size: 0.9rem; margin-bottom: 1rem;">
                    Feature importance analysis for Instance ${instanceId}
                </p>
            `;
            
            document.getElementById('explanationChart').style.display = 'block';
            
            // Destroy existing chart
            if (explanationChart) {
                explanationChart.destroy();
            }
            
            // Create new pie chart for better visibility
            const ctx = document.getElementById('explanationChart').getContext('2d');
            explanationChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.features,
                    datasets: [{
                        label: 'Feature Importance',
                        data: data.importance,
                        backgroundColor: [
                            'rgba(78, 205, 196, 0.8)',
                            'rgba(255, 107, 107, 0.8)',
                            'rgba(255, 206, 84, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)'
                        ],
                        borderColor: [
                            'rgba(78, 205, 196, 1)',
                            'rgba(255, 107, 107, 1)',
                            'rgba(255, 206, 84, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 2,
                        hoverBorderWidth: 3,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                color: '#ffffff',
                                font: {
                                    size: 12
                                },
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 46, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#e0e0e0',
                            borderColor: 'rgba(78, 205, 196, 0.5)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const percentage = (context.parsed * 100).toFixed(1);
                                    const value = data.values[context.dataIndex];
                                    return [`${context.label}: ${percentage}%`, `Value: ${value}`];
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
        }

        function showInstanceDetails(instanceId) {
            try {
                const data = explanationData[instanceId] || explanationData[1];
                const instanceRow = document.querySelector(`[data-instance-id="${instanceId}"]`);
                
                if (!instanceRow) {
                    console.error('Instance row not found for ID:', instanceId);
                    return;
                }
                
                const predictionElement = instanceRow.querySelector('.prediction-badge');
                const prediction = predictionElement ? predictionElement.textContent.trim() : 'Unknown';
                const confidence = instanceRow.cells && instanceRow.cells[5] ? instanceRow.cells[5].textContent : 'N/A';
                
                const instanceDetailsContent = document.getElementById('instanceDetailsContent');
                if (!instanceDetailsContent) {
                    console.error('Instance details content element not found');
                    return;
                }
                
                instanceDetailsContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div class="detail-card">
                            <div class="detail-label">Instance ID</div>
                            <div class="detail-value">${instanceId}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Prediction</div>
                            <div class="detail-value" style="color: ${prediction === 'Exoplanet' ? '#4CAF50' : '#F44336'};">${prediction}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Confidence</div>
                            <div class="detail-value">${confidence}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Key Feature</div>
                            <div class="detail-value">${data.features[0]}</div>
                        </div>
                    </div>
                    
                    <div class="feature-values-grid">
                        <h4 style="margin-bottom: 1rem; color: #4ecdc4; font-size: 1.1rem;">üìä Feature Values</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.8rem;">
                            ${data.features.map((feature, index) => `
                                <div class="feature-value-item">
                                    <div class="feature-name">${feature}</div>
                                    <div class="feature-value">${data.values[index]}</div>
                                    <div class="feature-importance">${(data.importance[index] * 100).toFixed(1)}% importance</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="analysis-summary">
                        <h4 style="margin-bottom: 0.8rem; color: #4ecdc4; font-size: 1.1rem;">üß† Analysis Summary</h4>
                        <p style="color: #e0e0e0; line-height: 1.6; margin-bottom: 0.8rem;">
                            The model classified this instance as <strong style="color: ${prediction === 'Exoplanet' ? '#4CAF50' : '#F44336'};">${prediction}</strong> with ${confidence} confidence.
                        </p>
                        <p style="color: #e0e0e0; line-height: 1.6;">
                            The most important features for this prediction were:
                            <br>1. <strong>${data.features[0]}</strong> (${(data.importance[0] * 100).toFixed(1)}% importance)
                            <br>2. <strong>${data.features[1]}</strong> (${(data.importance[1] * 100).toFixed(1)}% importance)
                            <br>3. <strong>${data.features[2]}</strong> (${(data.importance[2] * 100).toFixed(1)}% importance)
                        </p>
                    </div>
                `;
                
                console.log('Instance details updated for ID:', instanceId);
                
            } catch (error) {
                console.error('Error showing instance details:', error);
                const instanceDetailsContent = document.getElementById('instanceDetailsContent');
                if (instanceDetailsContent) {
                    instanceDetailsContent.innerHTML = `
                        <div style="color: #F44336; padding: 1rem; text-align: center;">
                            <p>‚ö†Ô∏è Error loading instance details</p>
                            <p style="font-size: 0.9rem; color: #b8b8b8;">Instance ID: ${instanceId}</p>
                        </div>
                    `;
                }
            }
        }

        async function initializeVisualization() {
            try {
                // Import Three.js modules
                const THREE = await import('https://unpkg.com/three@0.160.0/build/three.module.js');
                
                const canvas = document.getElementById('visualizationCanvas');
                const container = document.getElementById('visualizationWidget');
                
                if (!scene && canvas && container) {
                    scene = new THREE.Scene();
                    const maxWidth = Math.min(container.clientWidth, 600);
                    const maxHeight = Math.min(350, container.clientHeight || 350);
                    camera = new THREE.PerspectiveCamera(60, maxWidth / maxHeight, 0.1, 1000);
                    camera.position.set(0, 2.5, 10);
                    camera.lookAt(0, 0, 0);

                    renderer = new THREE.WebGLRenderer({ 
                        canvas: canvas, 
                        antialias: true,
                        alpha: false
                    });
                    renderer.setSize(maxWidth, maxHeight);
                    renderer.setClearColor(0x0a0a0a);
                    renderer.shadowMap.enabled = true;
                    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                    // Enhanced lighting setup
                    const pointLight = new THREE.PointLight(0xffffff, 1.5, 100, 2);
                    pointLight.position.set(-5, 10, -5);
                    pointLight.castShadow = true;
                    pointLight.shadow.mapSize.width = 1024;
                    pointLight.shadow.mapSize.height = 1024;
                    scene.add(pointLight);

                    const ambient = new THREE.AmbientLight(0x404040, 0.6);
                    scene.add(ambient);

                    // Add starfield background
                    createStarfield(THREE);

                    // Create planet objects
                    createPlanets(THREE);

                    // Start animation loop
                    animateVisualization();

                    // Setup button event listeners
                    setupVisualizationButtons();
                    
                    console.log('3D Visualization initialized successfully');
                }
            } catch (error) {
                console.error('Failed to initialize 3D visualization:', error);
                // Fallback to simple canvas rendering
                initializeFallbackVisualization();
            }
        }

        function createStarfield(THREE) {
            const starsGeometry = new THREE.BufferGeometry();
            const starsMaterial = new THREE.PointsMaterial({ 
                color: 0xFFFFFF, 
                size: 2,
                sizeAttenuation: false
            });
            
            const starsVertices = [];
            for (let i = 0; i < 1000; i++) {
                const x = (Math.random() - 0.5) * 200;
                const y = (Math.random() - 0.5) * 200;
                const z = (Math.random() - 0.5) * 200;
                starsVertices.push(x, y, z);
            }
            
            starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
            const stars = new THREE.Points(starsGeometry, starsMaterial);
            scene.add(stars);
        }

        function createPlanets(THREE) {
            // Earth-like planet
            const earthGeometry = new THREE.SphereGeometry(1, 32, 32);
            const earthMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x6b93d6,
                shininess: 100,
                specular: 0x222222
            });
            window.earthObject = new THREE.Mesh(earthGeometry, earthMaterial);
            window.earthObject.castShadow = true;
            window.earthObject.receiveShadow = true;
            scene.add(window.earthObject);

            // Haumea-like object (elongated)
            const haumeaGeometry = new THREE.SphereGeometry(1, 32, 16);
            haumeaGeometry.scale(1.5, 1, 1.2);
            const haumeaMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xd4af37,
                shininess: 50
            });
            window.haumeaObject = new THREE.Mesh(haumeaGeometry, haumeaMaterial);
            window.haumeaObject.visible = false;
            window.haumeaObject.castShadow = true;
            window.haumeaObject.receiveShadow = true;
            scene.add(window.haumeaObject);
            
            window.currentPlanet = 'earth';
        }

        function animateVisualization() {
            requestAnimationFrame(animateVisualization);
            
            if (window.currentPlanet === 'earth' && window.earthObject && window.earthObject.visible) {
                window.earthObject.rotation.y += 0.01;
                window.earthObject.rotation.x = Math.sin(Date.now() * 0.001) * 0.1;
            } else if (window.currentPlanet === 'haumea' && window.haumeaObject && window.haumeaObject.visible) {
                window.haumeaObject.rotation.z += 0.02;
                window.haumeaObject.rotation.y += 0.005;
            }
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        function setupVisualizationButtons() {
            const btnEarth = document.getElementById('btnEarth');
            const btnHaumea = document.getElementById('btnHaumea');
            
            if (btnEarth) {
                btnEarth.addEventListener('click', () => {
                    window.currentPlanet = 'earth';
                    if (window.earthObject) window.earthObject.visible = true;
                    if (window.haumeaObject) window.haumeaObject.visible = false;
                    updateVisualizationData();
                });
            }

            if (btnHaumea) {
                btnHaumea.addEventListener('click', () => {
                    window.currentPlanet = 'haumea';
                    if (window.earthObject) window.earthObject.visible = false;
                    if (window.haumeaObject) window.haumeaObject.visible = true;
                    updateVisualizationData();
                });
            }
        }

        function initializeFallbackVisualization() {
            const canvas = document.getElementById('visualizationCanvas');
            const container = document.getElementById('visualizationWidget');
            
            if (canvas && container) {
                const ctx = canvas.getContext('2d');
                const canvasWidth = Math.min(container.clientWidth, 600);
                const canvasHeight = Math.min(350, container.clientHeight || 350);
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                canvas.style.width = canvasWidth + 'px';
                canvas.style.height = canvasHeight + 'px';
                
                // Simple animated fallback
                let angle = 0;
                function drawFallback() {
                    ctx.fillStyle = '#0a0a0a';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw stars
                    ctx.fillStyle = 'white';
                    for (let i = 0; i < 100; i++) {
                        const x = (i * 137.5) % canvas.width;
                        const y = (i * 73.3) % canvas.height;
                        ctx.fillRect(x, y, 1, 1);
                    }
                    
                    // Draw rotating planet
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    const radius = 50;
                    
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                    ctx.fillStyle = window.currentPlanet === 'earth' ? '#6b93d6' : '#d4af37';
                    ctx.fill();
                    
                    // Add rotation effect
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, radius + 5, radius / 3, angle, 0, 2 * Math.PI);
                    ctx.stroke();
                    
                    angle += 0.02;
                    requestAnimationFrame(drawFallback);
                }
                drawFallback();
                
                // Setup buttons for fallback
                document.getElementById('btnEarth')?.addEventListener('click', () => {
                    window.currentPlanet = 'earth';
                });
                document.getElementById('btnHaumea')?.addEventListener('click', () => {
                    window.currentPlanet = 'haumea';
                });
                
                console.log('Fallback 2D visualization initialized');
            }
        }

        function updateVisualizationData() {
            // Update visualization based on selected instance
            if (selectedInstanceId && scene) {
                const instanceData = explanationData[selectedInstanceId];
                const prediction = document.querySelector(`[data-instance-id="${selectedInstanceId}"] .prediction-badge`).textContent.trim();
                
                // Change sphere color based on prediction
                const sphere = scene.children.find(child => child.type === 'Mesh' && child.geometry.type === 'SphereGeometry');
                if (sphere) {
                    const targetColor = prediction === 'Exoplanet' ? 0x4CAF50 : 0xF44336;
                    
                    // Animate color transition
                    const currentColor = new THREE.Color(sphere.material.color);
                    const targetColorObj = new THREE.Color(targetColor);
                    
                    // Smooth color transition
                    let progress = 0;
                    const colorAnimation = () => {
                        progress += 0.05;
                        if (progress <= 1) {
                            sphere.material.color.lerpColors(currentColor, targetColorObj, progress);
                            requestAnimationFrame(colorAnimation);
                        }
                    };
                    colorAnimation();
                    
                    // Scale based on confidence
                    const confidence = parseFloat(document.querySelector(`[data-instance-id="${selectedInstanceId}"]`).cells[5].textContent) / 100;
                    const targetScale = 0.8 + (confidence * 0.4); // Scale between 0.8 and 1.2
                    
                    // Animate scale
                    let scaleProgress = 0;
                    const currentScale = sphere.scale.x;
                    const scaleAnimation = () => {
                        scaleProgress += 0.03;
                        if (scaleProgress <= 1) {
                            const newScale = currentScale + (targetScale - currentScale) * scaleProgress;
                            sphere.scale.set(newScale, newScale, newScale);
                            requestAnimationFrame(scaleAnimation);
                        }
                    };
                    scaleAnimation();
                }
            }
        }

        // Resize handler for visualization
        window.addEventListener('resize', () => {
            if (renderer && camera) {
                const container = document.getElementById('visualizationWidget');
                if (container && container.clientWidth > 0 && container.style.display !== 'none') {
                    const newWidth = Math.min(container.clientWidth, 600);
                    const newHeight = Math.min(350, container.clientHeight || 350);
                    renderer.setSize(newWidth, newHeight);
                    camera.aspect = newWidth / newHeight;
                    camera.updateProjectionMatrix();
                }
            }
        });

        // Add keyboard shortcuts for better UX
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && selectedInstanceId) {
                // Clear selection
                clearInstanceSelection();
            } else if (event.key >= '1' && event.key <= '5') {
                // Quick select instances 1-5
                const instanceId = parseInt(event.key);
                const instanceExists = document.querySelector(`[data-instance-id="${instanceId}"]`);
                if (instanceExists) {
                    explainInstance(instanceId);
                }
            }
        });

        function clearInstanceSelection() {
            selectedInstanceId = null;
            
            // Remove highlights
            document.querySelectorAll('.result-row').forEach(row => {
                row.classList.remove('selected-instance');
            });
            
            // Hide widgets with animation
            const widgets = [
                document.getElementById('explanationWidget'),
                document.getElementById('visualizationWidget'),
                document.getElementById('instanceDetails')
            ];
            
            widgets.forEach(widget => {
                widget.style.opacity = '0';
                widget.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    widget.style.display = 'none';
                    widget.style.opacity = '';
                    widget.style.transform = '';
                }, 300);
            });
            
            // Reset confidence circle to overall
            resetConfidenceCircle();
        }

        function resetConfidenceCircle() {
            const confidenceCircle = document.querySelector('.confidence-circle');
            const confidenceText = document.querySelector('.confidence-text');
            const originalConfidence = {{ overall_confidence }};
            
            if (confidenceCircle && confidenceText) {
                confidenceCircle.style.setProperty('--percentage', `${originalConfidence * 3.6}deg`);
                confidenceText.textContent = `${originalConfidence}%`;
                confidenceText.style.color = '#4CAF50';
                
                const gradient = `conic-gradient(from 0deg, #4CAF50 0deg, #4CAF50 ${originalConfidence * 3.6}deg, rgba(255, 255, 255, 0.1) ${originalConfidence * 3.6}deg, rgba(255, 255, 255, 0.1) 360deg)`;
                confidenceCircle.style.background = gradient;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            // Add subtle animations to table rows
            const rows = document.querySelectorAll('.result-row');
            rows.forEach((row, index) => {
                row.style.opacity = '0';
                row.style.transform = 'translateX(-20px)';
                row.style.transition = 'all 0.3s ease-out';
                
                setTimeout(() => {
                    row.style.opacity = '1';
                    row.style.transform = 'translateX(0)';
                }, index * 100);
            });

            // Add help tooltip
            const helpTooltip = document.createElement('div');
            helpTooltip.innerHTML = `
                <div style="position: fixed; bottom: 20px; right: 20px; background: rgba(26, 26, 46, 0.95); 
                            color: white; padding: 1rem; border-radius: 10px; font-size: 0.9rem; 
                            border: 1px solid rgba(78, 205, 196, 0.3); max-width: 250px; z-index: 1000;">
                    <strong>üí° Tips:</strong><br>
                    ‚Ä¢ Click "Explain & Visualize" to analyze instances<br>
                    ‚Ä¢ Press 1-5 to quickly select instances<br>
                    ‚Ä¢ Press Escape to clear selection<br>
                    ‚Ä¢ Hover over chart bars for details
                </div>
            `;
            document.body.appendChild(helpTooltip);
            
            // Auto-hide help after 10 seconds
            setTimeout(() => {
                if (helpTooltip.parentNode) {
                    helpTooltip.style.opacity = '0';
                    setTimeout(() => {
                        helpTooltip.remove();
                    }, 300);
                }
            }, 10000);
        });
    </script>

    <script type="module">
        // Enhanced Three.js visualization integration
        import * as THREE from 'three';
        import { EffectComposer } from 'three/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/examples/jsm/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/examples/jsm/postprocessing/UnrealBloomPass.js';

        let vizScene, vizCamera, vizRenderer, vizComposer;
        let haumeaObject, earthObject;
        let currentPlanet = 'earth';

        function initializeEnhancedVisualization() {
            const canvas = document.getElementById('visualizationCanvas');
            const container = document.getElementById('visualizationWidget');
            
            if (!vizScene) {
                vizScene = new THREE.Scene();
                vizCamera = new THREE.PerspectiveCamera(60, container.clientWidth / 400, 0.1, 1000);
                vizCamera.position.set(0, 2.5, 10);
                vizCamera.lookAt(0, 0, 0);

                vizRenderer = new THREE.WebGLRenderer({ 
                    canvas: canvas, 
                    antialias: true,
                    alpha: true 
                });
                vizRenderer.setSize(container.clientWidth, 400);
                vizRenderer.setClearColor(0x000000, 1);
                vizRenderer.toneMapping = THREE.ReinhardToneMapping;

                // Enhanced lighting setup
                const pointLight = new THREE.PointLight(0xffffff, 3000, 100, 2);
                pointLight.position.set(-9, 10, -8);
                vizScene.add(pointLight);

                const ambient = new THREE.AmbientLight(0x404040, 0.4);
                vizScene.add(ambient);

                // Add starfield background
                createStarfield();

                // Create planet objects
                createPlanets();

                // Setup post-processing
                setupPostProcessing();

                // Start animation loop
                animateVisualization();

                // Setup button event listeners
                setupVizButtons();
            }
        }

        function createStarfield() {
            const starsGeometry = new THREE.BufferGeometry();
            const starsMaterial = new THREE.PointsMaterial({ color: 0xFFFFFF, size: 0.1 });
            
            const starsVertices = [];
            for (let i = 0; i < 1000; i++) {
                const x = (Math.random() - 0.5) * 2000;
                const y = (Math.random() - 0.5) * 2000;
                const z = (Math.random() - 0.5) * 2000;
                starsVertices.push(x, y, z);
            }
            
            starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
            const stars = new THREE.Points(starsGeometry, starsMaterial);
            vizScene.add(stars);
        }

        function createPlanets() {
            // Earth-like planet
            const earthGeometry = new THREE.SphereGeometry(1, 32, 32);
            const earthMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x6b93d6,
                shininess: 100,
                specular: 0x222222
            });
            earthObject = new THREE.Mesh(earthGeometry, earthMaterial);
            vizScene.add(earthObject);

            // Haumea-like object (elongated)
            const haumeaGeometry = new THREE.SphereGeometry(1, 32, 16);
            haumeaGeometry.scale(1.5, 1, 1.2); // Make it elongated
            const haumeaMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xd4af37,
                shininess: 50
            });
            haumeaObject = new THREE.Mesh(haumeaGeometry, haumeaMaterial);
            haumeaObject.visible = false;
            vizScene.add(haumeaObject);
        }

        function setupPostProcessing() {
            vizComposer = new EffectComposer(vizRenderer);
            
            const renderPass = new RenderPass(vizScene, vizCamera);
            vizComposer.addPass(renderPass);
            
            const bloomPass = new UnrealBloomPass(
                new THREE.Vector2(container.clientWidth, 400),
                1.5,  // strength
                0.4,  // radius
                0.85  // threshold
            );
            vizComposer.addPass(bloomPass);
        }

        function animateVisualization() {
            requestAnimationFrame(animateVisualization);
            
            if (currentPlanet === 'earth' && earthObject.visible) {
                earthObject.rotation.y += 0.01;
                earthObject.rotation.x = Math.sin(Date.now() * 0.001) * 0.1;
            } else if (currentPlanet === 'haumea' && haumeaObject.visible) {
                haumeaObject.rotation.z += 0.02;
                haumeaObject.rotation.y += 0.005;
            }
            
            if (vizComposer) {
                vizComposer.render();
            } else if (vizRenderer) {
                vizRenderer.render(vizScene, vizCamera);
            }
        }

        function setupVizButtons() {
            document.getElementById('btnEarth').addEventListener('click', () => {
                currentPlanet = 'earth';
                earthObject.visible = true;
                haumeaObject.visible = false;
                
                // Animate transition
                gsap.to(earthObject.scale, { duration: 1, x: 1, y: 1, z: 1, ease: "back.out(1.7)" });
            });

            document.getElementById('btnHaumea').addEventListener('click', () => {
                currentPlanet = 'haumea';
                earthObject.visible = false;
                haumeaObject.visible = true;
                
                // Animate transition
                gsap.to(haumeaObject.scale, { duration: 1, x: 1, y: 1, z: 1, ease: "back.out(1.7)" });
            });
        }

        // Override the basic initialization with enhanced version
        window.initializeVisualization = initializeEnhancedVisualization;
    </script>

    <!-- Add GSAP for animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
</body>
</html>